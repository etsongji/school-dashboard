<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™êµìƒí™œ - ì¶©ì£¼ê³ ë“±í•™êµ</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://api.allorigins.win">
    <link rel="preconnect" href="https://calendar.google.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Netlify Identity Widget -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <!-- CMS ë°ì´í„° ë¡œë” -->
    <script src="js/cms-loader.js"></script>
</head>
<body>
    <!-- í—¤ë” -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <img src="images/school-logo.png" alt="ì¶©ì£¼ê³ ë“±í•™êµ ë¡œê³ " class="school-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                <i class="fas fa-graduation-cap" style="display: none;"></i>
                <span>ì¶©ì£¼ê³ ë“±í•™êµ</span>
            </div>
            
            <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
            <nav class="nav">
                <a href="#" class="nav-link active">í™ˆ</a>
                <a href="calendar.html" class="nav-link">í•™ì‚¬ì¼ì •</a>
                <a href="#" class="nav-link">ê¸‰ì‹ì •ë³´</a>
                <a href="notices.html" class="nav-link">ê³µì§€ì‚¬í•­</a>
                <a href="rules.html" class="nav-link">êµì¹™</a>
                
                <!-- í•™ë…„ë³„ ë“œë¡­ë‹¤ìš´ -->
                <div class="dropdown">
                    <button class="dropdown-btn">
                        <span>í•™ë…„ë³„</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu">
                        <a href="#" class="dropdown-item">1í•™ë…„</a>
                        <a href="#" class="dropdown-item">2í•™ë…„</a>
                        <a href="#" class="dropdown-item">3í•™ë…„</a>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <!-- ê³µì§€ì‚¬í•­ íšŒì „ ë°°ë„ˆ -->
    <div class="notice-banner" id="noticeBanner">
        <div class="notice-banner-content">
            <i class="fas fa-bullhorn"></i>
            <span id="noticeBannerText">ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
        </div>
        <button class="notice-close-btn" onclick="closeNoticeBanner()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- ë©”ì¸ ë ˆì´ì•„ì›ƒ -->
    <div class="main-layout">

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="main-content">
            <!-- 2ì—´ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ -->
            <div class="content-grid">
                <!-- ì™¼ìª½ ì˜ì—­ -->
                <div class="left-column">
                    <!-- ì˜¤ëŠ˜ì˜ í•™êµ ì¼ì • -->
                    <section class="schedule-section">
                        <div class="section-header">
                            <h2>í•™êµ ì¼ì •</h2>
                            <div class="date-navigation">
                                <button class="date-nav-btn" onclick="changeScheduleDate(-1)">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <div class="date-display" onclick="openDatePicker()">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span id="selectedDate">ë‚ ì§œ ë¡œë”©ì¤‘...</span>
                                    <input type="date" id="datePicker" style="display: none;" onchange="selectDate(this.value)">
                                </div>
                                <button class="date-nav-btn" onclick="changeScheduleDate(1)">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                                <button class="refresh-btn" onclick="window.googleCalendar.loadCalendarData()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="schedule-list">
                            <div class="schedule-loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span id="scheduleLoadingText">í•™ì‚¬ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
                            </div>
                        </div>
                    </section>

                    <!-- ì´ì£¼ì˜ ì£¼ìš”ì¼ì • -->
                    <section class="weekly-schedule-section">
                        <div class="section-header">
                            <h2>ì´ì£¼ì˜ ì£¼ìš”ì¼ì •</h2>
                        </div>
                        
                        <div class="weekly-schedule-list">
                            <div class="weekly-loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>ì£¼ìš”ì¼ì • ë¡œë”© ì¤‘...</span>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- ì˜¤ë¥¸ìª½ ì˜ì—­ -->
                <div class="right-column">
                    <!-- ë¹ ë¥¸ ë©”ë‰´ -->
                    <section class="quick-menu-section">
                        <h3>ë¹ ë¥¸ ë©”ë‰´</h3>
                        <div class="quick-menu-grid">
                            <button class="quick-menu-btn schedule-btn">
                                <i class="fas fa-calendar-alt"></i>
                            </button>
                            <button class="quick-menu-btn meal-btn">
                                <i class="fas fa-utensils"></i>
                            </button>
                            <button class="quick-menu-btn rules-btn">
                                <i class="fas fa-book-open"></i>
                            </button>
                            <button class="quick-menu-btn notice-btn" onclick="location.href='notices.html'">
                                <i class="fas fa-bullhorn"></i>
                            </button>
                        </div>
                    </section>

                    <!-- ì˜¤ëŠ˜ì˜ ê¸‰ì‹ -->
                    <section class="meal-card-section">
                        <h3>ì˜¤ëŠ˜ì˜ ê¸‰ì‹</h3>
                        
                        <div class="meal-card">
                            <!-- ê¸‰ì‹ íƒ­ -->
                            <div class="meal-tabs-compact">
                                <button id="compactBreakfastBtn" class="meal-tab-compact" data-meal-type="1">ì•„ì¹¨</button>
                                <button id="compactLunchBtn" class="meal-tab-compact active" data-meal-type="2">ì ì‹¬</button>
                                <button id="compactDinnerBtn" class="meal-tab-compact" data-meal-type="3">ì €ë…</button>
                            </div>
                            
                            <!-- ê¸‰ì‹ ë©”ë‰´ -->
                            <div class="meal-content-compact">
                                <div id="compactMealCard" class="compact-meal-display">
                                    <div class="meal-loading-compact">ê¸‰ì‹ ì •ë³´ ë¡œë”© ì¤‘...</div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <!-- í‘¸í„° -->
    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 ì¶©ì£¼ê³ ë“±í•™êµ. ëª¨ë“  ê¶Œë¦¬ ë³´ìœ .</p>
            <p>ë¬¸ì˜: etsongji@korea.kr | ì „í™”: 043-840-8702</p>
        </div>
    </footer>

    <script src="js/app.js"></script>
    <script src="js/calendar.js"></script>
    <script src="js/meal.js"></script>
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let compactMealCard;
        let googleCalendar;

        // DOM ë¡œë“œ ì™„ë£Œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // í˜„ì¬ ë‚ ì§œ í‘œì‹œ
            updateTodayDate();
            
            // ë“œë¡­ë‹¤ìš´ ê¸°ëŠ¥ ì´ˆê¸°í™”
            initDropdown();
            
            // ê¸‰ì‹ íƒ­ ê¸°ëŠ¥ ì´ˆê¸°í™”
            initMealTabs();
            
            // ì»´íŒ©íŠ¸ ê¸‰ì‹ ì¹´ë“œ ì´ˆê¸°í™”
            compactMealCard = new CompactMealCard();
            
            // Google Calendar ì´ˆê¸°í™”
            window.googleCalendar = new GoogleCalendarSchedule();
        });

        // ì˜¤ëŠ˜ ë‚ ì§œ ì—…ë°ì´íŠ¸
        function updateTodayDate() {
            const today = new Date();
            const options = { month: 'long', day: 'numeric', weekday: 'short' };
            const dateString = today.toLocaleDateString('ko-KR', options);
            document.getElementById('todayDate').textContent = dateString;
        }

        // ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
        function initDropdown() {
            const dropdown = document.querySelector('.dropdown');
            const dropdownBtn = dropdown.querySelector('.dropdown-btn');
            const dropdownMenu = dropdown.querySelector('.dropdown-menu');

            dropdownBtn.addEventListener('click', function() {
                dropdown.classList.toggle('active');
            });

            // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
            document.addEventListener('click', function(e) {
                if (!dropdown.contains(e.target)) {
                    dropdown.classList.remove('active');
                }
            });
        }

        // ê¸‰ì‹ íƒ­ ì´ˆê¸°í™”
        function initMealTabs() {
            const mealTabs = document.querySelectorAll('.meal-tab');
            
            mealTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // ëª¨ë“  íƒ­ì—ì„œ active ì œê±°
                    mealTabs.forEach(t => t.classList.remove('active'));
                    // í´ë¦­ëœ íƒ­ì— active ì¶”ê°€
                    this.classList.add('active');
                    
                    // ë©”ë‰´ í‘œì‹œ/ìˆ¨ê¹€
                    const mealType = this.dataset.meal;
                    document.querySelectorAll('.meal-menu-display').forEach(menu => {
                        menu.style.display = 'none';
                    });
                    document.getElementById(mealType + 'Menu').style.display = 'block';
                });
            });
        }

        // Google Calendar í´ë˜ìŠ¤
        class GoogleCalendarSchedule {
            constructor() {
                this.icsUrl = 'https://calendar.google.com/calendar/ical/36ba3c711fc38c700924941125d4c03392c69e553db7e596977f241d65465dc6%40group.calendar.google.com/public/basic.ics';
                this.events = [];
                this.debugMode = false; // ë””ë²„ê·¸ ëª¨ë“œ ë¹„í™œì„±í™”
                this.selectedDate = new Date(); // ì„ íƒëœ ë‚ ì§œ
                this.cacheKey = 'calendar_data_cache';
                this.cacheTimeout = 10 * 60 * 1000; // 10ë¶„ ìºì‹œ (ë” ìì£¼ ì—…ë°ì´íŠ¸)
                this.init();
            }

            init() {
                this.updateSelectedDateDisplay();
                // ì¦‰ì‹œ ê¸°ë³¸ ìŠ¤ì¼€ì¤„ í‘œì‹œ
                this.showDefaultSchedule();
                // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤ì œ ë°ì´í„° ë¡œë“œ
                setTimeout(() => this.loadCalendarData(), 100);
            }

            async loadCalendarData() {
                console.log('ğŸ”„ ìº˜ë¦°ë” ë°ì´í„° ë¡œë”© ì‹œì‘...');
                
                // ìºì‹œ í™•ì¸
                const cachedData = this.getCachedData();
                if (cachedData) {
                    console.log('ğŸ“‹ ìºì‹œëœ ë°ì´í„° ì‚¬ìš©');
                    this.updateLoadingText('ìºì‹œëœ ë°ì´í„° ë¡œë”©...');
                    this.events = cachedData;
                    this.updateScheduleDisplay();
                    this.updateWeeklyScheduleDisplay();
                    return;
                }
                
                this.updateLoadingText('êµ¬ê¸€ ìº˜ë¦°ë”ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ì¤‘...');
                
                try {
                    const data = await this.fetchCalendarData();
                    console.log('ğŸ“¥ ICS ë°ì´í„° ìˆ˜ì‹ :', data ? `${data.length}ì` : 'null');
                    
                    if (!data || data.length === 0) {
                        throw new Error('ë¹ˆ ICS ë°ì´í„°');
                    }
                    
                    // ICS ë°ì´í„° ì¼ë¶€ ì¶œë ¥
                    console.log('ğŸ“„ ICS ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°:', data.substring(0, 500) + '...');
                    
                    this.events = this.parseICS(data);
                    console.log('ğŸ“… íŒŒì‹±ëœ ì´ë²¤íŠ¸ ìˆ˜:', this.events.length);
                    
                    if (this.events.length > 0) {
                        console.log('ğŸ“‹ ì²« ë²ˆì§¸ ì´ë²¤íŠ¸:', this.events[0]);
                        console.log('ğŸ“‹ ëª¨ë“  ì´ë²¤íŠ¸ ì œëª©:', this.events.map(e => e.summary));
                        
                        // ìºì‹œì— ì €ì¥
                        this.setCachedData(this.events);
                    }
                    
                    this.updateScheduleDisplay();
                    this.updateWeeklyScheduleDisplay();
                } catch (error) {
                    console.error('âŒ Google Calendar ë¡œë”© ì‹¤íŒ¨:', error);
                    this.showCalendarError();
                }
            }

            async fetchCalendarData() {
                console.log('ğŸŒ í”„ë¡ì‹œ ìš”ì²­ ì‹œì‘...');
                
                // CORS ìš°íšŒë¥¼ ìœ„í•œ í”„ë¡ì‹œ ì‚¬ìš©
                try {
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(this.icsUrl)}`;
                    console.log('ğŸ”— AllOrigins ì‹œë„:', proxyUrl);
                    const response = await fetch(proxyUrl);
                    console.log('ğŸ“¡ AllOrigins ì‘ë‹µ:', response.status, response.statusText);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('ğŸ“¦ AllOrigins ë°ì´í„°:', data);
                        if (data.contents && data.contents.length > 0) {
                            console.log('âœ… AllOrigins ì„±ê³µ!');
                            
                            // base64 ë°ì´í„°ì¸ì§€ í™•ì¸í•˜ê³  ë””ì½”ë”©
                            let contents = data.contents;
                            if (contents.startsWith('data:text/calendar') && contents.includes('base64,')) {
                                console.log('ğŸ”“ Base64 ë°ì´í„° ë””ì½”ë”© ì¤‘...');
                                const base64Data = contents.split('base64,')[1];
                                
                                // UTF-8 ë””ì½”ë”©ì„ ìœ„í•´ ë°”ì´íŠ¸ ë°°ì—´ë¡œ ë³€í™˜ í›„ í…ìŠ¤íŠ¸ ë””ì½”ë” ì‚¬ìš©
                                const binaryString = atob(base64Data);
                                const bytes = new Uint8Array(binaryString.length);
                                for (let i = 0; i < binaryString.length; i++) {
                                    bytes[i] = binaryString.charCodeAt(i);
                                }
                                contents = new TextDecoder('utf-8').decode(bytes);
                                console.log('âœ… UTF-8 ë””ì½”ë”© ì™„ë£Œ');
                            }
                            
                            return contents;
                        }
                    }
                } catch (error) {
                    console.log('âŒ AllOrigins ì‹¤íŒ¨:', error.message);
                }

                // ë‹¤ë¥¸ í”„ë¡ì‹œ ì‹œë„
                try {
                    const proxyUrl = `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(this.icsUrl)}`;
                    console.log('ğŸ”— CodeTabs ì‹œë„:', proxyUrl);
                    const response = await fetch(proxyUrl);
                    console.log('ğŸ“¡ CodeTabs ì‘ë‹µ:', response.status, response.statusText);
                    
                    if (response.ok) {
                        const text = await response.text();
                        console.log('âœ… CodeTabs ì„±ê³µ!');
                        return text;
                    }
                } catch (error) {
                    console.log('âŒ CodeTabs ì‹¤íŒ¨:', error.message);
                }

                // ì§ì ‘ ìš”ì²­ ì‹œë„ (CORS ì—ëŸ¬ ë°œìƒí•  ê°€ëŠ¥ì„± ë†’ìŒ)
                try {
                    console.log('ğŸ”— ì§ì ‘ ìš”ì²­ ì‹œë„...');
                    const response = await fetch(this.icsUrl);
                    console.log('ğŸ“¡ ì§ì ‘ ìš”ì²­ ì‘ë‹µ:', response.status, response.statusText);
                    
                    if (response.ok) {
                        const text = await response.text();
                        console.log('âœ… ì§ì ‘ ìš”ì²­ ì„±ê³µ!');
                        return text;
                    }
                } catch (error) {
                    console.log('âŒ ì§ì ‘ ìš”ì²­ ì‹¤íŒ¨:', error.message);
                }

                throw new Error('ìº˜ë¦°ë” ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }

            parseICS(icsData) {
                const events = [];
                const lines = icsData.split('\n');
                let currentEvent = null;

                for (let line of lines) {
                    line = line.trim();

                    if (line === 'BEGIN:VEVENT') {
                        currentEvent = {};
                    } else if (line === 'END:VEVENT' && currentEvent) {
                        if (currentEvent.summary && currentEvent.dtstart) {
                            events.push(currentEvent);
                        }
                        currentEvent = null;
                    } else if (currentEvent) {
                        if (line.startsWith('SUMMARY:')) {
                            currentEvent.summary = line.substring(8);
                        } else if (line.startsWith('DTSTART')) {
                            const dateMatch = line.match(/DTSTART[^:]*:(\d{8}T?\d{0,6}Z?)/);
                            if (dateMatch) {
                                currentEvent.dtstart = this.parseDate(dateMatch[1]);
                            }
                        } else if (line.startsWith('DTEND')) {
                            const dateMatch = line.match(/DTEND[^:]*:(\d{8}T?\d{0,6}Z?)/);
                            if (dateMatch) {
                                currentEvent.dtend = this.parseDate(dateMatch[1]);
                            }
                        } else if (line.startsWith('LOCATION:')) {
                            currentEvent.location = line.substring(9);
                        } else if (line.startsWith('DESCRIPTION:')) {
                            currentEvent.description = line.substring(12);
                        }
                    }
                }

                return events.sort((a, b) => a.dtstart - b.dtstart);
            }

            parseDate(dateString) {
                console.log('ğŸ“… ë‚ ì§œ íŒŒì‹±:', dateString);
                // YYYYMMDD ë˜ëŠ” YYYYMMDDTHHMMSSZ í˜•ì‹ íŒŒì‹±
                if (dateString.length >= 8) {
                    const year = parseInt(dateString.substring(0, 4));
                    const month = parseInt(dateString.substring(4, 6)) - 1;
                    const day = parseInt(dateString.substring(6, 8));
                    
                    let parsedDate;
                    if (dateString.length > 8 && dateString.includes('T')) {
                        const hour = parseInt(dateString.substring(9, 11)) || 0;
                        const minute = parseInt(dateString.substring(11, 13)) || 0;
                        parsedDate = new Date(year, month, day, hour, minute);
                    } else {
                        parsedDate = new Date(year, month, day);
                    }
                    
                    console.log('ğŸ•’ íŒŒì‹± ê²°ê³¼:', parsedDate.toDateString());
                    return parsedDate;
                }
                return new Date();
            }

            updateScheduleDisplay() {
                const selectedDate = new Date(this.selectedDate);
                selectedDate.setHours(0, 0, 0, 0);
                console.log('ğŸ“† ì„ íƒëœ ë‚ ì§œ:', selectedDate.toDateString());
                
                const selectedDateEvents = this.events.filter(event => {
                    const eventDate = new Date(event.dtstart);
                    eventDate.setHours(0, 0, 0, 0);
                    const isSelectedDate = eventDate.getTime() === selectedDate.getTime();
                    console.log('ğŸ” ì´ë²¤íŠ¸ ì²´í¬:', event.summary, 'ë‚ ì§œ:', eventDate.toDateString(), 'ì„ íƒëœ ë‚ ì§œì¸ê°€?', isSelectedDate);
                    return isSelectedDate;
                });

                console.log('ğŸ¯ ì„ íƒëœ ë‚ ì§œì˜ ì´ë²¤íŠ¸:', selectedDateEvents.length, 'ê°œ');

                const scheduleList = document.querySelector('.schedule-list');
                if (!scheduleList) return;

                if (selectedDateEvents.length === 0) {
                    console.log('ğŸ“ ì„ íƒëœ ë‚ ì§œ ì¼ì •ì´ ì—†ìŒ');
                    this.showNoSchedule();
                    return;
                }

                const scheduleHTML = selectedDateEvents.map((event, index) => {
                    const eventTime = event.dtstart.toLocaleTimeString('ko-KR', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    const icon = this.getEventIcon(event.summary);
                    const grade = this.getEventGrade(event.summary);
                    const location = event.location || 'ë¯¸ì •';

                    return `
                        <div class="schedule-card">
                            <div class="schedule-icon">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div class="schedule-content">
                                <h3>${event.summary}</h3>
                                <div class="schedule-details">
                                    <span class="location">
                                        <i class="fas fa-map-marker-alt"></i>
                                        ${location}
                                    </span>
                                    <span class="grade-badge ${grade.class}">${grade.text}</span>
                                    <span class="time">${eventTime}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                scheduleList.innerHTML = scheduleHTML;
            }

            updateWeeklyScheduleDisplay() {
                const today = new Date();
                const nextWeek = new Date(today);
                nextWeek.setDate(today.getDate() + 14);

                const weeklyEvents = this.events.filter(event => {
                    const eventDate = new Date(event.dtstart);
                    return eventDate >= today && eventDate <= nextWeek;
                }).slice(0, 4); // ìµœëŒ€ 4ê°œë§Œ

                const weeklyList = document.querySelector('.weekly-schedule-list');
                if (!weeklyList) return;

                if (weeklyEvents.length === 0) {
                    this.showNoWeeklySchedule();
                    return;
                }

                const weeklyHTML = weeklyEvents.map(event => {
                    const eventDate = event.dtstart.toLocaleDateString('ko-KR', { 
                        month: 'numeric', 
                        day: 'numeric',
                        weekday: 'short'
                    });

                    return `
                        <div class="weekly-schedule-item">
                            <div class="week-date">${eventDate}</div>
                            <div class="week-event">${event.summary}</div>
                        </div>
                    `;
                }).join('');

                weeklyList.innerHTML = weeklyHTML;
            }

            getEventIcon(summary) {
                const title = summary.toLowerCase();
                if (title.includes('ì‹œí—˜') || title.includes('ê³ ì‚¬')) return 'fa-clipboard-list';
                if (title.includes('íšŒì˜') || title.includes('ëª¨ì„')) return 'fa-users';
                if (title.includes('ìƒë‹´') || title.includes('ë©´ë‹´')) return 'fa-user-tie';
                if (title.includes('í–‰ì‚¬') || title.includes('ì¶•ì œ')) return 'fa-calendar-check';
                if (title.includes('íœ´ë¬´') || title.includes('ë°©í•™')) return 'fa-calendar-times';
                return 'fa-calendar-alt';
            }

            getEventGrade(summary) {
                const title = summary.toLowerCase();
                // ì—¬ëŸ¬ í•™ë…„ì´ í¬í•¨ëœ ê²½ìš° ì²´í¬
                const hasGrade1 = title.includes('1í•™ë…„') || title.includes('1,2') || title.includes('1, 2');
                const hasGrade2 = title.includes('2í•™ë…„') || title.includes('1,2') || title.includes('1, 2') || title.includes('2,3') || title.includes('2, 3');
                const hasGrade3 = title.includes('3í•™ë…„') || title.includes('2,3') || title.includes('2, 3');
                
                // ë³µìˆ˜ í•™ë…„ì¸ ê²½ìš°
                if ((hasGrade1 && hasGrade2 && hasGrade3) || title.includes('ì „í•™ë…„') || title.includes('ì „ì²´')) {
                    return { class: 'all-grade', text: 'ì „í•™ë…„' };
                } else if (hasGrade1 && hasGrade2) {
                    return { class: 'grade-12', text: '1,2í•™ë…„' };
                } else if (hasGrade2 && hasGrade3) {
                    return { class: 'grade-23', text: '2,3í•™ë…„' };
                } else if (hasGrade1) {
                    return { class: 'grade-1', text: '1í•™ë…„' };
                } else if (hasGrade2) {
                    return { class: 'grade-2', text: '2í•™ë…„' };
                } else if (hasGrade3) {
                    return { class: 'grade-3', text: '3í•™ë…„' };
                } else {
                    return { class: 'all-grade', text: 'ì „í•™ë…„' };
                }
            }



            showNoSchedule() {
                const scheduleList = document.querySelector('.schedule-list');
                if (!scheduleList) return;

                scheduleList.innerHTML = `
                    <div class="no-schedule">
                        <div class="no-schedule-icon">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <div class="no-schedule-content">
                            <h3>ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                            <p>ì˜¤ëŠ˜ì€ ì˜ˆì •ëœ í•™êµ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                `;
            }

            showNoWeeklySchedule() {
                const weeklyList = document.querySelector('.weekly-schedule-list');
                if (!weeklyList) return;

                weeklyList.innerHTML = `
                    <div class="no-weekly-schedule">
                        <div class="no-schedule-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="no-schedule-content">
                            <h3>ì˜ˆì •ëœ ì£¼ìš” ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                            <p>í–¥í›„ 2ì£¼ê°„ ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                `;
            }

            showCalendarError() {
                const scheduleList = document.querySelector('.schedule-list');
                const weeklyList = document.querySelector('.weekly-schedule-list');
                
                const errorHTML = `
                    <div class="calendar-error">
                        <div class="no-schedule-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="no-schedule-content">
                            <h3>ì¼ì •ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
                            <p>ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê³  ìƒˆë¡œê³ ì¹¨í•´ ì£¼ì„¸ìš”.</p>
                        </div>
                    </div>
                `;
                
                if (scheduleList) {
                    scheduleList.innerHTML = errorHTML;
                }
                if (weeklyList) {
                    weeklyList.innerHTML = errorHTML;
                }
            }

            // ì„ íƒëœ ë‚ ì§œ ì—…ë°ì´íŠ¸
            updateSelectedDateDisplay() {
                const dateSpan = document.getElementById('selectedDate');
                if (dateSpan) {
                    const options = { month: 'long', day: 'numeric', weekday: 'short' };
                    const dateString = this.selectedDate.toLocaleDateString('ko-KR', options);
                    dateSpan.textContent = dateString;
                }
            }

            // ë‚ ì§œ ë³€ê²½
            changeDate(direction) {
                const newDate = new Date(this.selectedDate);
                newDate.setDate(newDate.getDate() + direction);
                this.selectedDate = newDate;
                this.updateSelectedDateDisplay();
                this.updateScheduleDisplay();
            }

            // íŠ¹ì • ë‚ ì§œë¡œ ì„¤ì •
            setDate(dateString) {
                this.selectedDate = new Date(dateString);
                this.updateSelectedDateDisplay();
                this.updateScheduleDisplay();
            }

            // ìºì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            getCachedData() {
                try {
                    const cached = localStorage.getItem(this.cacheKey);
                    if (!cached) return null;

                    const { data, timestamp } = JSON.parse(cached);
                    const now = new Date().getTime();

                    // ìºì‹œ ë§Œë£Œ í™•ì¸
                    if (now - timestamp > this.cacheTimeout) {
                        localStorage.removeItem(this.cacheKey);
                        return null;
                    }

                    // ì´ë²¤íŠ¸ ê°ì²´ì˜ ë‚ ì§œ ë³µì›
                    return data.map(event => ({
                        ...event,
                        dtstart: new Date(event.dtstart),
                        dtend: new Date(event.dtend)
                    }));
                } catch (error) {
                    console.warn('ìºì‹œ ì½ê¸° ì˜¤ë¥˜:', error);
                    return null;
                }
            }

            // ìºì‹œ ë°ì´í„° ì €ì¥
            setCachedData(events) {
                try {
                    const cacheData = {
                        data: events,
                        timestamp: new Date().getTime()
                    };
                    localStorage.setItem(this.cacheKey, JSON.stringify(cacheData));
                    console.log('ğŸ“ ìºì‹œì— ì €ì¥ë¨');
                } catch (error) {
                    console.warn('ìºì‹œ ì €ì¥ ì˜¤ë¥˜:', error);
                }
            }

            // ë¡œë”© í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            updateLoadingText(text) {
                const loadingElement = document.getElementById('scheduleLoadingText');
                if (loadingElement) {
                    loadingElement.textContent = text;
                }
            }

            // ì¦‰ì‹œ í‘œì‹œí•  ê¸°ë³¸ ìŠ¤ì¼€ì¤„
            showDefaultSchedule() {
                const scheduleList = document.querySelector('.schedule-list');
                if (!scheduleList) return;

                const today = new Date();
                const dayOfWeek = today.getDay(); // 0: ì¼ìš”ì¼, 1: ì›”ìš”ì¼, ...

                // ê¸°ë³¸ ì‹œê°„í‘œ (ìš”ì¼ë³„)
                const defaultSchedules = {
                    1: [ // ì›”ìš”ì¼
                        { time: '08:00', title: 'ì¡°íšŒ', icon: 'fa-users', type: 'general' },
                        { time: '09:00', title: '1êµì‹œ', icon: 'fa-book', type: 'class' },
                        { time: '12:30', title: 'ì¤‘ì‹ì‹œê°„', icon: 'fa-utensils', type: 'meal' }
                    ],
                    2: [ // í™”ìš”ì¼
                        { time: '08:00', title: 'ì¡°íšŒ', icon: 'fa-users', type: 'general' },
                        { time: '09:00', title: '1êµì‹œ', icon: 'fa-book', type: 'class' },
                        { time: '12:30', title: 'ì¤‘ì‹ì‹œê°„', icon: 'fa-utensils', type: 'meal' }
                    ],
                    3: [ // ìˆ˜ìš”ì¼
                        { time: '08:00', title: 'ì¡°íšŒ', icon: 'fa-users', type: 'general' },
                        { time: '09:00', title: '1êµì‹œ', icon: 'fa-book', type: 'class' },
                        { time: '12:30', title: 'ì¤‘ì‹ì‹œê°„', icon: 'fa-utensils', type: 'meal' }
                    ],
                    4: [ // ëª©ìš”ì¼
                        { time: '08:00', title: 'ì¡°íšŒ', icon: 'fa-users', type: 'general' },
                        { time: '09:00', title: '1êµì‹œ', icon: 'fa-book', type: 'class' },
                        { time: '12:30', title: 'ì¤‘ì‹ì‹œê°„', icon: 'fa-utensils', type: 'meal' }
                    ],
                    5: [ // ê¸ˆìš”ì¼
                        { time: '08:00', title: 'ì¡°íšŒ', icon: 'fa-users', type: 'general' },
                        { time: '09:00', title: '1êµì‹œ', icon: 'fa-book', type: 'class' },
                        { time: '12:30', title: 'ì¤‘ì‹ì‹œê°„', icon: 'fa-utensils', type: 'meal' }
                    ],
                    0: [ // ì¼ìš”ì¼
                        { time: 'íœ´ì¼', title: 'íœ´ì¼ì…ë‹ˆë‹¤', icon: 'fa-calendar-day', type: 'holiday' }
                    ],
                    6: [ // í† ìš”ì¼
                        { time: 'íœ´ì¼', title: 'íœ´ì¼ì…ë‹ˆë‹¤', icon: 'fa-calendar-day', type: 'holiday' }
                    ]
                };

                const todaySchedule = defaultSchedules[dayOfWeek] || [];
                
                if (todaySchedule.length === 0) {
                    scheduleList.innerHTML = `
                        <div class="no-schedule">
                            <i class="fas fa-calendar-check"></i>
                            <h3>ì˜¤ëŠ˜ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                            <p>êµ¬ê¸€ ìº˜ë¦°ë”ì—ì„œ ìµœì‹  ì¼ì •ì„ í™•ì¸í•˜ëŠ” ì¤‘...</p>
                        </div>
                    `;
                    return;
                }

                const scheduleHTML = todaySchedule.map(item => `
                    <div class="schedule-card default-schedule">
                        <div class="schedule-icon">
                            <i class="fas ${item.icon}"></i>
                        </div>
                        <div class="schedule-content">
                            <h3>${item.title}</h3>
                            <div class="schedule-details">
                                <span class="location">
                                    <i class="fas fa-map-marker-alt"></i>
                                    êµì‹¤
                                </span>
                                <span class="grade-badge general">ì „ì²´</span>
                                <span class="time">${item.time}</span>
                            </div>
                        </div>
                    </div>
                `).join('');

                scheduleList.innerHTML = scheduleHTML + `
                    <div class="loading-overlay">
                        <small><i class="fas fa-sync fa-spin"></i> ì‹¤ì‹œê°„ ì¼ì • ì—…ë°ì´íŠ¸ ì¤‘...</small>
                    </div>
                `;
            }
        }

        // ì»´íŒ©íŠ¸ ê¸‰ì‹ ì¹´ë“œ í´ë˜ìŠ¤
        class CompactMealCard {
            constructor() {
                this.apiKey = 'cc1b9c0a34804a628cc701f43a8398e1';
                this.schoolCode = '8000078';
                this.officeCode = 'M10';
                this.baseURL = 'https://open.neis.go.kr/hub/mealServiceDietInfo';
                this.currentDate = new Date();
                this.currentMealType = '2'; // ê¸°ë³¸ê°’: ì¤‘ì‹
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.loadMealData();
            }
            
            setupEventListeners() {
                // ì¡°ì‹ ë²„íŠ¼
                const breakfastBtn = document.getElementById('compactBreakfastBtn');
                if (breakfastBtn) {
                    breakfastBtn.addEventListener('click', () => {
                        this.selectMealType('1');
                    });
                }
                
                // ì¤‘ì‹ ë²„íŠ¼
                const lunchBtn = document.getElementById('compactLunchBtn');
                if (lunchBtn) {
                    lunchBtn.addEventListener('click', () => {
                        this.selectMealType('2');
                    });
                }
                
                // ì„ì‹ ë²„íŠ¼
                const dinnerBtn = document.getElementById('compactDinnerBtn');
                if (dinnerBtn) {
                    dinnerBtn.addEventListener('click', () => {
                        this.selectMealType('3');
                    });
                }
            }
            
            selectMealType(mealType) {
                this.currentMealType = mealType;
                this.updateActiveButton();
                this.loadMealData();
            }
            
            updateActiveButton() {
                // ëª¨ë“  ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
                document.querySelectorAll('.meal-tab-compact').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // í˜„ì¬ ì„ íƒëœ íƒ€ì…ì˜ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
                const activeButton = document.querySelector(`[data-meal-type="${this.currentMealType}"]`);
                if (activeButton && activeButton.classList.contains('meal-tab-compact')) {
                    activeButton.classList.add('active');
                }
            }
            
            formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}${month}${day}`;
            }
            
            async loadMealData() {
                const container = document.getElementById('compactMealCard');
                if (!container) return;
                
                container.innerHTML = '<div class="meal-loading-compact"><i class="fas fa-spinner fa-spin"></i> ë¡œë”© ì¤‘...</div>';
                
                try {
                    const data = await this.fetchMealData();
                    this.displayMealCard(data);
                } catch (error) {
                    this.showNoMealMessage();
                }
            }
            
            async fetchMealData() {
                const dateStr = this.formatDate(this.currentDate);
                const targetUrl = `${this.baseURL}?KEY=${this.apiKey}&Type=json&pIndex=1&pSize=100&ATPT_OFCDC_SC_CODE=${this.officeCode}&SD_SCHUL_CODE=${this.schoolCode}&MLSV_YMD=${dateStr}`;
                
                // 1. ì§ì ‘ ìš”ì²­ ì‹œë„
                try {
                    const response = await fetch(targetUrl, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.mealServiceDietInfo) {
                            return data;
                        }
                    }
                } catch (error) {
                    console.log('ì§ì ‘ ìš”ì²­ ì‹¤íŒ¨:', error.message);
                }
                
                // 2. AllOrigins í”„ë¡ì‹œ ì‹œë„
                try {
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;
                    const response = await fetch(proxyUrl);
                    
                    if (response.ok) {
                        const proxyData = await response.json();
                        if (proxyData.contents) {
                            const data = JSON.parse(proxyData.contents);
                            if (data.mealServiceDietInfo) {
                                return data;
                            }
                        }
                    }
                } catch (error) {
                    console.log('AllOrigins í”„ë¡ì‹œ ì‹¤íŒ¨:', error.message);
                }
                
                throw new Error('ëª¨ë“  API í˜¸ì¶œ ë°©ë²•ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            }
            
            displayMealCard(data) {
                const container = document.getElementById('compactMealCard');
                
                if (!data.mealServiceDietInfo) {
                    this.showNoMealMessage();
                    return;
                }
                
                const meals = data.mealServiceDietInfo[1].row;
                const targetMealName = this.getMealTypeName(this.currentMealType);
                
                const targetMeal = meals.find(meal => {
                    const mealCode = String(meal.MMEAL_SC_NM);
                    return mealCode === this.currentMealType || mealCode === targetMealName;
                });
                
                if (!targetMeal) {
                    this.showNoMealMessage();
                    return;
                }
                
                this.displayFoundMeal(targetMeal);
            }
            
            displayFoundMeal(targetMeal) {
                const container = document.getElementById('compactMealCard');
                
                const menuItems = targetMeal.DDISH_NM
                    .replace(/<br\/>/g, '\n')
                    .replace(/<[^>]*>/g, '')
                    .split('\n')
                    .filter(item => item.trim())
                    .map(item => item.replace(/\*[\d.]+/g, '').trim()); // ì•Œë ˆë¥´ê¸° ì •ë³´ ì œê±°
                
                const menuHTML = menuItems.slice(0, 4).map(item => 
                    `<div class="meal-item-compact">${item}</div>`
                ).join('');
                
                container.innerHTML = `
                    <div class="compact-meal-menu">
                        ${menuHTML}
                        ${menuItems.length > 4 ? `<div class="meal-more-compact">+${menuItems.length - 4}ê°œ ë”</div>` : ''}
                    </div>
                `;
            }
            
            
            showNoMealMessage() {
                const container = document.getElementById('compactMealCard');
                
                container.innerHTML = `
                    <div class="no-meal-compact">
                        <div class="no-meal-icon">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <div class="no-meal-content">
                            <h4>${this.getMealTypeName(this.currentMealType)} ì •ë³´ ì—†ìŒ</h4>
                            <p>ì˜¤ëŠ˜ ${this.getMealTypeName(this.currentMealType)} ì •ë³´ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                `;
            }
            
            getMealTypeName(code) {
                const mealTypes = {
                    '1': 'ì¡°ì‹',
                    '2': 'ì¤‘ì‹', 
                    '3': 'ì„ì‹'
                };
                return mealTypes[code] || 'ì¤‘ì‹';
            }
        }

        // ì „ì—­ í•¨ìˆ˜ë“¤ - HTMLì—ì„œ í˜¸ì¶œë¨
        function changeScheduleDate(direction) {
            if (window.googleCalendar) {
                window.googleCalendar.changeDate(direction);
            }
        }

        function openDatePicker() {
            const datePicker = document.getElementById('datePicker');
            if (datePicker) {
                // í˜„ì¬ ì„ íƒëœ ë‚ ì§œë¥¼ input valueë¡œ ì„¤ì •
                const currentDate = window.googleCalendar ? window.googleCalendar.selectedDate : new Date();
                datePicker.value = currentDate.toISOString().split('T')[0];
                datePicker.click();
            }
        }

        function selectDate(dateString) {
            if (window.googleCalendar && dateString) {
                window.googleCalendar.setDate(dateString);
            }
        }
    </script>

    <!-- Netlify Identity ì´ˆê¸°í™” -->
    <script>
        if (window.netlifyIdentity) {
            window.netlifyIdentity.on("init", user => {
                if (!user) {
                    window.netlifyIdentity.on("login", () => {
                        document.location.href = "/admin/";
                    });
                }
            });
        }
    </script>
</body>
</html>